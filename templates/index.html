<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Milky Translator</title>
    <link
      href="{{ url_for('static', filename='css/bootstrap.min.css') }}"
      rel="stylesheet"
    />
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link 
      rel="stylesheet" 
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        background: radial-gradient(circle at 10% 20%, #fff8e7, #e5f0ff 45%, #ffffff 70%);
        font-family: "Space Grotesk", "Helvetica Neue", Arial, sans-serif;
      }
      .brand-badge {
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(6px);
      }
      .hero-title {
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .pill {
        border-radius: 999px;
      }
      .auth-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.8), rgba(229, 240, 255, 0.85));
        backdrop-filter: blur(6px);
        z-index: 2000;
      }
      .auth-card {
        width: min(420px, 92vw);
      }
    </style>
  </head>
  <body>
    <nav class="navbar bg-transparent">
      <div class="container">
        <span class="navbar-brand mb-0 h1 brand-badge text-dark">Milky Translator</span>
      </div>
    </nav>

    <main class="container pb-5">
      <form method="post" id="form">
        <input type="hidden" name="api_key" id="api_key_value" value="{{ api_key }}" />
        <div class="p-4 rounded-4 glass-card">
          <div class="row g-3 mt-1">
            <div class="col-12 col-lg-6">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <select class="w-50 form-select" id="source_language" name="source_language">
                  {% for code, label in languages %}
                  <option value="{{ code }}" {% if code == source_language %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                  id="swapLanguagesButton"
                  aria-label="언어 전환"
                >
                  <i class="bi bi-arrow-left-right"></i>
                </button>
              </div>
              <textarea class="form-control" id="text" name="text" rows="10" placeholder="번역할 내용">{{ text }}</textarea>
            </div>
            <div class="col-12 col-lg-6">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <select class="w-50 form-select" id="target_language" name="target_language">
                  {% for code, label in languages %}
                  <option value="{{ code }}" {% if code == target_language %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                  id="copyTranslationButton"
                  aria-label="번역 복사"
                >
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              <div class="p-3 bg-light rounded-3 border">
                <pre class="mb-0 fs-6" id="translationOutput">{{ translation }}</pre>
              </div>
            </div>
          </div>

          {% if error %}
          <div class="alert alert-danger" role="alert">
            {{ error }}
          </div>
          {% endif %}

          <div class="row g-3 mt-3 align-items-center">

              <div class="col input-group mb-2">
                <label class="input-group-text" for="model">모델</label>
                <select class="form-select" id="model" name="model">
                  {% for code, label in model_options %}
                  <option value="{{ code }}" {% if code == model %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col input-group mb-2">
                <label class="input-group-text" for="select-thinking-level">사고 수준</label>
                <select class="form-select" id="select-thinking-level" name="level">
                  {% for code, label in thinking_level_options %}
                  <option value="{{ code }}" {% if code == level %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            <div class="col-auto d-flex gap-2 align-items-center">
              <input
                type="checkbox"
                class="form-check-input"
                id="text-wrap-checkbox"
              />
              <label class="form-check-label" for="text-wrap-checkbox">줄바꿈</label>
              <button
                type="button"
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#promptModal"
              >
                프롬프트 템플릿
              </button>
              <button
                type="button"
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#apiKeyModal"
              >
                API 키 설정
              </button>
              <button type="submit" class="btn btn-primary px-4" id="transrate-btn">
                번역하기
              </button>
            </div>
          </div>
          <input type="hidden" id="prompt_template_value" name="prompt_template" value="{{ prompt_template }}" />
        </div>
      </form>
    </main>

    <div
      class="modal fade"
      id="promptModal"
      tabindex="-1"
      aria-labelledby="promptModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="promptModalLabel">프롬프트 템플릿</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea
              class="form-control"
              id="promptTemplateInput"
              rows="8"
              spellcheck="false"
            >{{ prompt_template }}</textarea>
            <div class="form-text mt-2">
              {{'{{source}}'}}, {{'{{target}}'}}, {{'{{text}}'}} 필수
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">닫기</button>
              <button type="button" class="btn btn-primary" id="savePromptButton">적용</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="apiKeyModal"
      tabindex="-1"
      aria-labelledby="apiKeyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="apiKeyModalLabel">API 키 설정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if env_api_key_set %}
            <div class="alert alert-info small" role="alert">
              환경변수에 GEMINI_API_KEY가 지정되어 있습니다. 입력하지 않으면 기본 키가 사용됩니다.
            </div>
            {% endif %}
            <input
              type="password"
              class="form-control"
              id="apiKeyInput"
              autocomplete="off"
              placeholder="여기에 API 키를 입력하세요"
            />
            <div class="form-text">이 요청에만 사용되며 저장되지 않습니다.</div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-primary" id="saveApiKeyButton">적용</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
      const apiKeyHiddenField = document.getElementById("api_key_value");
      const apiKeyInput = document.getElementById("apiKeyInput");
      const apiKeyModalEl = document.getElementById("apiKeyModal");
      const apiKeyModal = apiKeyModalEl ? bootstrap.Modal.getOrCreateInstance(apiKeyModalEl) : null;

      const promptHiddenField = document.getElementById("prompt_template_value");
      const promptInput = document.getElementById("promptTemplateInput");
      const promptModalEl = document.getElementById("promptModal");
      const promptModal = promptModalEl ? bootstrap.Modal.getOrCreateInstance(promptModalEl) : null;
      const PROMPT_STORAGE_KEY = "milkyTranslator.promptTemplate";

      const translateButton = document.getElementById("transrate-btn");

      const setPromptTemplateValue = (value) => {
        if (promptHiddenField) {
          promptHiddenField.value = value;
        }
        if (promptInput) {
          promptInput.value = value;
        }
      };

      const getCachedPromptTemplate = () => {
        try {
          return localStorage.getItem(PROMPT_STORAGE_KEY);
        } catch (error) {
          return null;
        }
      };

      const savePromptTemplateToCache = (value) => {
        try {
          localStorage.setItem(PROMPT_STORAGE_KEY, value);
        } catch (error) {}
      };

      const loadPromptTemplate = async () => {
        if (!promptHiddenField) return;

        const cachedPrompt = getCachedPromptTemplate();
        if (cachedPrompt) {
          setPromptTemplateValue(cachedPrompt);
          return;
        }

        try {
          const response = await fetch("/prompt-template");
          if (!response.ok) throw new Error("Failed to load prompt template");
          const data = await response.json();
          const serverPrompt = data?.prompt_template || promptHiddenField.value;
          setPromptTemplateValue(serverPrompt);
          savePromptTemplateToCache(serverPrompt);
        } catch (error) {
          // Keep whatever server rendered if fetch/localStorage is unavailable
          setPromptTemplateValue(promptHiddenField.value);
          savePromptTemplateToCache(promptHiddenField.value);
        }
      };

      loadPromptTemplate();

      // 줄바꿈 버튼 기능
      const textWrapCheckbox = document.getElementById("text-wrap-checkbox");
      const TEXT_WRAP_STORAGE_KEY = "milkyTranslator.textWrap";

      // pre 요소에 줄바꿈 스타일 적용
      const applyTextWrap = (checked) => {
        const output = document.getElementById("translationOutput");
        if (!output) return;
        output.style.whiteSpace = checked ? "pre-wrap" : "pre";
      };

      // 저장된 줄바꿈 설정 불러오기
      const loadTextWrapPreference = () => {
        try {
          const saved = localStorage.getItem(TEXT_WRAP_STORAGE_KEY);
          if (saved === null) return;

          const isChecked = saved === "true";
          if (textWrapCheckbox) {
            textWrapCheckbox.checked = isChecked;
          }
          applyTextWrap(isChecked);
        } catch (error) {}
      };

      loadTextWrapPreference();
      
      // 체크박스 리스너 등록
      textWrapCheckbox?.addEventListener("change", (event) => {
        const isChecked = Boolean(event.target.checked);
        applyTextWrap(isChecked);
        try {
          localStorage.setItem(TEXT_WRAP_STORAGE_KEY, String(isChecked));
        } catch (error) {}
      });

      document.getElementById("form").addEventListener("submit", () => {
        if (!promptHiddenField || !promptInput) return;
        translateButton.disabled = true;
        translateButton.innerText = "번역 중...";
      });

      document.getElementById("saveApiKeyButton")?.addEventListener("click", () => {
        if (!apiKeyHiddenField || !apiKeyInput || !apiKeyModal) return;
        apiKeyHiddenField.value = apiKeyInput.value.trim();
        apiKeyModal.hide();
      });

      document.getElementById("clearApiKeyButton")?.addEventListener("click", () => {
        if (!apiKeyHiddenField || !apiKeyInput) return;
        apiKeyInput.value = "";
        apiKeyHiddenField.value = "";
      });

      apiKeyModalEl?.addEventListener("shown.bs.modal", () => {
        if (!apiKeyInput) return;
        apiKeyInput.value = apiKeyHiddenField?.value || "";
        apiKeyInput.focus();
      });

      document.getElementById("savePromptButton")?.addEventListener("click", () => {
        if (!promptHiddenField || !promptInput || !promptModal) return;
        const nextPrompt = promptInput.value.trim();
        setPromptTemplateValue(nextPrompt);
        savePromptTemplateToCache(nextPrompt);
        promptModal.hide();
      });

      promptModalEl?.addEventListener("shown.bs.modal", () => {
        if (!promptInput) return;
        promptInput.value = promptHiddenField?.value || "";
        promptInput.focus();
      });

      const translationOutput = document.getElementById("translationOutput");
      const copyTranslationButton = document.getElementById("copyTranslationButton");
      const swapLanguagesButton = document.getElementById("swapLanguagesButton");
      const sourceLanguageSelect = document.getElementById("source_language");
      const targetLanguageSelect = document.getElementById("target_language");

      swapLanguagesButton?.addEventListener("click", () => {
        if (!sourceLanguageSelect || !targetLanguageSelect) return;
        const temp = sourceLanguageSelect.value;
        sourceLanguageSelect.value = targetLanguageSelect.value;
        targetLanguageSelect.value = temp;
      });

      if (copyTranslationButton) {
        const originalCopyButtonHTML = copyTranslationButton.innerHTML;
        const originalCopyButtonAriaLabel =
          copyTranslationButton.getAttribute("aria-label") || "번역 복사";

        const setCopyButtonState = (iconClass, ariaLabel) => {
          copyTranslationButton.innerHTML = `<i class="${iconClass}"></i>`;
          copyTranslationButton.setAttribute("aria-label", ariaLabel);
        };

        const resetCopyButtonState = () => {
          copyTranslationButton.innerHTML = originalCopyButtonHTML;
          copyTranslationButton.setAttribute("aria-label", originalCopyButtonAriaLabel);
        };

        copyTranslationButton.addEventListener("click", async () => {
          if (!translationOutput) return;
          const text = translationOutput.innerText.trim();
          if (!text) return;

          try {
            await navigator.clipboard.writeText(translationOutput.innerText);
            setCopyButtonState("bi bi-clipboard-check", "복사 완료");
          } catch (error) {
            setCopyButtonState("bi bi-exclamation-triangle", "복사 실패");
          } finally {
            setTimeout(resetCopyButtonState, 1200);
          }
        });
      }
    </script>
  </body>
  </html>
