<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Milky Translator</title>
    <link
      href="{{ url_for('static', filename='css/bootstrap.min.css') }}"
      rel="stylesheet"
    />
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link 
      rel="stylesheet" 
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        background: radial-gradient(circle at 10% 20%, #fff8e7, #e5f0ff 45%, #ffffff 70%);
        font-family: "Space Grotesk", "Helvetica Neue", Arial, sans-serif;
      }
      .brand-badge {
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(6px);
      }
      .hero-title {
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .pill {
        border-radius: 999px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar bg-transparent">
      <div class="container">
        <span class="navbar-brand mb-0 h1 brand-badge text-dark">Milky Translator</span>
      </div>
    </nav>

    <main class="container pb-5">
      <form method="post" id="form">
        <input type="hidden" name="api_key" id="api_key_value" value="{{ api_key }}" />
        <div class="p-4 rounded-4 glass-card">
          <!-- 입력 / 출력 -->
          <div class="row g-3 mt-1">
            <div class="col-12 col-lg-6">
              <div class="d-flex align-items-center gap-2 mb-2">
                <select class="form-select" id="source_language" name="source_language">
                  {% for code, label in languages %}
                  <option value="{{ code }}" {% if code == source_language %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                  id="swapLanguagesButton"
                  aria-label="언어 전환"
                >
                  <i class="bi bi-arrow-left-right"></i>
                </button>
              </div>
              <textarea class="form-control" id="text" name="text" rows="10" placeholder="번역할 내용">{{ text }}</textarea>
            </div>
            <div class="col-12 col-lg-6">
              <div class="d-flex align-items-center gap-2 mb-2">
                <select class="form-select flex-grow-1" id="target_language" name="target_language">
                  {% for code, label in languages %}
                  <option value="{{ code }}" {% if code == target_language %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                  id="copyTranslationButton"
                  aria-label="번역 복사"
                >
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              <div class="p-3 bg-light rounded-3 border">
                <pre class="mb-0 fs-6" id="translationOutput">{{ translation }}</pre>
              </div>
            </div>
          </div>
          <!-- 에러 -->
          {% if error %}
          <div class="alert alert-danger" role="alert">
            {{ error }}
          </div>
          {% endif %}


          <!-- 설정 -->
          <div class="row g-3 mt-3 align-items-center">
            <div class="col">
              <select class="form-select" id="model" name="model">
                {% for code, label in model_options %}
                <option value="{{ code }}" {% if code == model %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-auto d-flex gap-2">
              <button
                type="button"
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#promptModal"
              >
                프롬프트 템플릿
              </button>
              <button
                type="button"
                class="btn btn-light"
                data-bs-toggle="modal"
                data-bs-target="#apiKeyModal"
              >
                API 키 설정
              </button>
              <button type="submit" class="btn btn-primary px-4" id="transrate-btn">
                번역하기
              </button>
            </div>
          </div>
          <input type="hidden" id="prompt_template_value" name="prompt_template" value="{{ prompt_template }}" />
        </div>
      </form>
    </main>

    <!-- Prompt Modal -->
    <div
      class="modal fade"
      id="promptModal"
      tabindex="-1"
      aria-labelledby="promptModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="promptModalLabel">프롬프트 템플릿</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea
              class="form-control"
              id="promptTemplateInput"
              rows="8"
              spellcheck="false"
            >{{ prompt_template }}</textarea>
            <div class="form-text mt-2">
              {{'{{source}}'}}, {{'{{target}}'}}, {{'{{text}}'}} 필수
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">닫기</button>
              <button type="button" class="btn btn-primary" id="savePromptButton">적용</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- API Key Modal -->
    <div
      class="modal fade"
      id="apiKeyModal"
      tabindex="-1"
      aria-labelledby="apiKeyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="apiKeyModalLabel">API 키 설정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if env_api_key_set %}
            <div class="alert alert-info small" role="alert">
              환경변수에 GEMINI_API_KEY가 지정되어 있습니다. 입력하지 않으면 기본 키가 사용됩니다.
            </div>
            {% endif %}
            <input
              type="password"
              class="form-control"
              id="apiKeyInput"
              autocomplete="off"
              placeholder="여기에 API 키를 입력하세요"
            />
            <div class="form-text">이 요청에만 사용되며 저장되지 않습니다.</div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-primary" id="saveApiKeyButton">적용</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
      const apiKeyHiddenField = document.getElementById("api_key_value");
      const apiKeyInput = document.getElementById("apiKeyInput");
      const apiKeyModalEl = document.getElementById("apiKeyModal");
      const apiKeyModal = apiKeyModalEl ? bootstrap.Modal.getOrCreateInstance(apiKeyModalEl) : null;

      const promptHiddenField = document.getElementById("prompt_template_value");
      const promptInput = document.getElementById("promptTemplateInput");
      const promptModalEl = document.getElementById("promptModal");
      const promptModal = promptModalEl ? bootstrap.Modal.getOrCreateInstance(promptModalEl) : null;

      const translateButton = document.getElementById("transrate-btn");

      document.getElementById("form").addEventListener("submit", () => {
        if (!promptHiddenField || !promptInput) return;
        translateButton.disabled = true;
        translateButton.innerText = "번역 중...";
      });

      document.getElementById("saveApiKeyButton")?.addEventListener("click", () => {
        if (!apiKeyHiddenField || !apiKeyInput || !apiKeyModal) return;
        apiKeyHiddenField.value = apiKeyInput.value.trim();
        apiKeyModal.hide();
      });

      document.getElementById("clearApiKeyButton")?.addEventListener("click", () => {
        if (!apiKeyHiddenField || !apiKeyInput) return;
        apiKeyInput.value = "";
        apiKeyHiddenField.value = "";
      });

      apiKeyModalEl?.addEventListener("shown.bs.modal", () => {
        if (!apiKeyInput) return;
        apiKeyInput.value = apiKeyHiddenField?.value || "";
        apiKeyInput.focus();
      });

      document.getElementById("savePromptButton")?.addEventListener("click", () => {
        if (!promptHiddenField || !promptInput || !promptModal) return;
        promptHiddenField.value = promptInput.value.trim();
        promptModal.hide();
      });

      promptModalEl?.addEventListener("shown.bs.modal", () => {
        if (!promptInput) return;
        promptInput.value = promptHiddenField?.value || "";
        promptInput.focus();
      });

      const translationOutput = document.getElementById("translationOutput");
      const copyTranslationButton = document.getElementById("copyTranslationButton");
      const swapLanguagesButton = document.getElementById("swapLanguagesButton");
      const sourceLanguageSelect = document.getElementById("source_language");
      const targetLanguageSelect = document.getElementById("target_language");

      swapLanguagesButton?.addEventListener("click", () => {
        if (!sourceLanguageSelect || !targetLanguageSelect) return;
        const temp = sourceLanguageSelect.value;
        sourceLanguageSelect.value = targetLanguageSelect.value;
        targetLanguageSelect.value = temp;
      });

      if (copyTranslationButton) {
        const originalCopyButtonHTML = copyTranslationButton.innerHTML;
        const originalCopyButtonAriaLabel =
          copyTranslationButton.getAttribute("aria-label") || "번역 복사";

        const setCopyButtonState = (iconClass, ariaLabel) => {
          copyTranslationButton.innerHTML = `<i class="${iconClass}"></i>`;
          copyTranslationButton.setAttribute("aria-label", ariaLabel);
        };

        const resetCopyButtonState = () => {
          copyTranslationButton.innerHTML = originalCopyButtonHTML;
          copyTranslationButton.setAttribute("aria-label", originalCopyButtonAriaLabel);
        };

        copyTranslationButton.addEventListener("click", async () => {
          if (!translationOutput) return;
          const text = translationOutput.innerText.trim();
          if (!text) return;

          try {
            await navigator.clipboard.writeText(translationOutput.innerText);
            setCopyButtonState("bi bi-clipboard-check", "복사 완료");
          } catch (error) {
            setCopyButtonState("bi bi-exclamation-triangle", "복사 실패");
          } finally {
            setTimeout(resetCopyButtonState, 1200);
          }
        });
      }

    </script>
  </body>
  </html>
